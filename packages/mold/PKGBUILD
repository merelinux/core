#!/bin/bash
# shellcheck disable=SC2034,SC2154,SC2068

pkgname=(mold)
pkgver=2.4.0
pkgrel=1
pkgdesc='A Modern Linker'
arch=(x86_64)
url='https://github.com/rui314/mold'
license=(GAGPL)
groups=(build-base)
depends=(
    "ld-musl-$(arch).so.1"
    libc++.so.1
    libc++abi.so.1
    libunwind.so.1
    libz.so.1
)
makedepends=(
	cmake
	ninja
	zlib-ng-dev
)
options=()
changelog=ChangeLog
source=(
    "https://github.com/rui314/mold/archive/refs/tags/v${pkgver}.tar.gz"
)

sha256sums=(
    be65f3d785d32ece7b3204ecaa57810847fdd25c232cf704cbfff2dafb1ac107
)

build() {
    cd_unpacked_src
    install -d build
    cd build || return 1
	cmake -G Ninja -Wno-dev \
        -DCMAKE_BUILD_TYPE=Release \
        -DCLANG_BUILD_EXAMPLES=OFF \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DCMAKE_INSTALL_LIBDIR=lib \
        ..
    ninja
}

package() {
    cd_unpacked_src
    cd build || return 1
    export DESTDIR="${pkgdirbase}/dest"
    cmake --build . --target install
    ln -sf mold "${pkgdirbase}/dest/usr/bin/ld"
    std_split_package
}
